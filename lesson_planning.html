<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahayak - AI Teaching Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #60a5fa;
            --bg-color: #ffffff;
            --sidebar-bg: #f8fafc;
            --chat-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --user-msg-bg: #f1f5f9;
            --bot-msg-bg: #f8fafc;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --hover-color: rgba(59, 130, 246, 0.05);
            --radius: 6px;
            --transition: all 0.2s ease;
        }

        [data-theme="dark"] {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #60a5fa;
            --bg-color: #1e293b;
            --sidebar-bg: #0f172a;
            --chat-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --user-msg-bg: #334155;
            --bot-msg-bg: #334155;
            --hover-color: rgba(59, 130, 246, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            z-index: 100;
            border-right: 1px solid var(--border-color);
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .logo i {
            font-size: 18px;
            color: white;
        }

        .new-chat-btn {
            margin: 16px;
            padding: 12px 16px;
            background-color: var(--primary-color);
            border: none;
            color: white;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .new-chat-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .conversation-history {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .conversation-item {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background-color 0.2s;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversation-item:hover {
            background-color: var(--hover-color);
        }

        .conversation-item.active {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--primary-color);
        }

        .conversation-actions {
            display: none;
            gap: 5px;
        }

        .conversation-item:hover .conversation-actions {
            display: flex;
        }

        .conversation-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.2s, background-color 0.2s;
        }

        .conversation-action-btn:hover {
            color: var(--text-primary);
            background-color: var(--hover-color);
        }

        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .theme-toggle:hover {
            background-color: var(--hover-color);
        }

        /* Main Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
        }

        .chat-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .header-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s, background-color 0.2s;
            font-size: 16px;
        }

        .header-action-btn:hover {
            color: var(--primary-color);
            background-color: var(--hover-color);
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .message {
            display: flex;
            gap: 16px;
            max-width: 100%;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.user .message-content {
            background-color: var(--user-msg-bg);
            border-radius: 18px 18px 4px 18px;
        }

        .message.bot .message-content {
            background-color: var(--bot-msg-bg);
            border-radius: 18px 18px 18px 4px;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            font-size: 16px;
        }

        .user .avatar {
            background-color: var(--primary-color);
            color: white;
        }

        .bot .avatar {
            background-color: #d1d5db;
            color: #374151;
        }

        .message-content {
            padding: 16px;
            max-width: 85%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .message-text {
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .message-text h1, .message-text h2, .message-text h3 {
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .message-text ul, .message-text ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .message-text li {
            margin-bottom: 4px;
        }

        .message-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
        }

        /* Input Area */
        .input-container {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .input-wrapper {
            max-width: 768px;
            margin: 0 auto;
            position: relative;
        }

        .input-options {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .option-btn {
            background-color: var(--sidebar-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .option-btn:hover {
            background-color: var(--hover-color);
        }

        .option-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .grade-selector {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .grade-selector select {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-size: 14px;
        }

        .chat-input {
            width: 100%;
            padding: 12px 50px 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            resize: none;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.5;
            max-height: 200px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            background-color: var(--bg-color);
            color: var(--text-primary);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .send-button {
            position: absolute;
            right: 12px;
            bottom: 12px;
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 16px;
            transition: color 0.2s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            color: var(--primary-dark);
        }

        .send-button:disabled {
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        /* Loading Animation */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 16px;
            background-color: var(--bot-msg-bg);
            border-radius: 18px 18px 18px 4px;
            max-width: 85%;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                z-index: 100;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .menu-toggle {
                display: block;
            }

            .message-content {
                max-width: 90%;
            }
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .empty-state h2 {
            font-size: 20px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state p {
            max-width: 500px;
            line-height: 1.5;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--bg-color);
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .modal-btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }

        .modal-btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .modal-btn-secondary {
            background-color: var(--sidebar-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .modal-btn-secondary:hover {
            background-color: var(--hover-color);
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background-color: var(--sidebar-bg);
        }

        .status-indicator.success {
            color: var(--primary-color);
            background-color: rgba(59, 130, 246, 0.1);
        }

        .status-indicator.danger {
            color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
        }

        /* Tooltips */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-primary);
            color: var(--bg-color);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo"><i class="fas fa-robot"></i></div>
            <h1>Sahayak AI</h1>
        </div>
        <button class="new-chat-btn" id="newChatBtn">
            <i class="fas fa-plus"></i> New Chat
        </button>
        <div class="conversation-history" id="conversationHistory">
            <!-- Conversation history will be populated here -->
        </div>
        <div class="sidebar-footer">
            <div class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
                <span>Dark Mode</span>
            </div>
            <p>Sahayak - Lesson Planning Assistant</p>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-container">
        <div class="chat-header">
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="chat-title" id="chatTitle">AI Teaching Assistant</div>
            <div class="header-actions">
                <button class="header-action-btn tooltip" id="savePlanBtn" data-tooltip="Save">
                    <i class="fas fa-save"></i>
                </button>
                <button class="header-action-btn tooltip" id="exportPlanBtn" data-tooltip="Export">
                    <i class="fas fa-download"></i>
                </button>
                <button class="header-action-btn tooltip" id="sharePlanBtn" data-tooltip="Share">
                    <i class="fas fa-share-alt"></i>
                </button>
                <button class="header-action-btn tooltip" id="clearChatBtn" data-tooltip="Clear">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <div class="empty-state" id="emptyState">
                <h2>Welcome to EduAI</h2>
                <p>Create engaging lesson plans with AI assistance. Start by typing a message below.</p>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <div class="input-options" id="inputOptions">
                    <button class="option-btn active" data-option="lesson">
                        <i class="fas fa-book"></i> Lesson Plan
                    </button>
                    <button class="option-btn" data-option="activity">
                        <i class="fas fa-puzzle-piece"></i> Activity
                    </button>
                    <button class="option-btn" data-option="assessment">
                        <i class="fas fa-clipboard-check"></i> Assessment
                    </button>
                </div>
                <div class="grade-selector" id="gradeSelector" style="display: none;">
                    <label for="gradeSelect">Grade Level:</label>
                    <select id="gradeSelect">
                        <option value="">Select Grade</option>
                        <option value="K">Kindergarten</option>
                        <option value="1">1st Grade</option>
                        <option value="2">2nd Grade</option>
                        <option value="3">3rd Grade</option>
                        <option value="4">4th Grade</option>
                        <option value="5">5th Grade</option>
                        <option value="6">6th Grade</option>
                        <option value="7">7th Grade</option>
                        <option value="8">8th Grade</option>
                        <option value="9">9th Grade</option>
                        <option value="10">10th Grade</option>
                        <option value="11">11th Grade</option>
                        <option value="12">12th Grade</option>
                        <option value="College">College/University</option>
                    </select>
                </div>
                <textarea 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Message EduAI..." 
                    rows="1"
                ></textarea>
                <button class="send-button" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Delete Lesson Plan</div>
                <button class="modal-close" id="deleteModalClose">&times;</button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this lesson plan? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="deleteModalCancel">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="deleteModalConfirm">Delete</button>
            </div>
        </div>
    </div>

    <!-- Clear All Modal -->
    <div class="modal" id="clearAllModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Clear All Lesson Plans</div>
                <button class="modal-close" id="clearAllModalClose">&times;</button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete all lesson plans? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="clearAllModalCancel">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="clearAllModalConfirm">Clear All</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Export Lesson Plan</div>
                <button class="modal-close" id="exportModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <p>Choose export format:</p>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                    <button class="option-btn" data-format="pdf">
                        <i class="fas fa-file-pdf"></i> PDF Document
                    </button>
                    <button class="option-btn" data-format="docx">
                        <i class="fas fa-file-word"></i> Word Document
                    </button>
                    <button class="option-btn" data-format="txt">
                        <i class="fas fa-file-alt"></i> Plain Text
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class EduAIChat {
            constructor() {
                this.currentConversationId = null;
                this.isWaitingForGrade = false;
                this.isGenerating = false;
                this.conversations = [];
                this.conversationToDelete = null;
                this.currentTheme = localStorage.getItem('eduai-theme') || 'light';
                this.currentOption = 'lesson';
                
                this.initializeElements();
                this.attachEventListeners();
                this.loadConversations();
                this.applyTheme();
            }

            initializeElements() {
                this.sidebar = document.getElementById('sidebar');
                this.menuToggle = document.getElementById('menuToggle');
                this.newChatBtn = document.getElementById('newChatBtn');
                this.conversationHistory = document.getElementById('conversationHistory');
                this.messagesContainer = document.getElementById('messagesContainer');
                this.emptyState = document.getElementById('emptyState');
                this.chatInput = document.getElementById('chatInput');
                this.sendButton = document.getElementById('sendButton');
                this.gradeSelector = document.getElementById('gradeSelector');
                this.gradeSelect = document.getElementById('gradeSelect');
                this.chatTitle = document.getElementById('chatTitle');
                this.themeToggle = document.getElementById('themeToggle');
                this.savePlanBtn = document.getElementById('savePlanBtn');
                this.exportPlanBtn = document.getElementById('exportPlanBtn');
                this.sharePlanBtn = document.getElementById('sharePlanBtn');
                this.clearChatBtn = document.getElementById('clearChatBtn');
                this.inputOptions = document.getElementById('inputOptions');
                this.chatHeader = document.querySelector('.chat-header');
                
                // Modal elements
                this.deleteModal = document.getElementById('deleteModal');
                this.deleteModalClose = document.getElementById('deleteModalClose');
                this.deleteModalCancel = document.getElementById('deleteModalCancel');
                this.deleteModalConfirm = document.getElementById('deleteModalConfirm');
                
                this.clearAllModal = document.getElementById('clearAllModal');
                this.clearAllModalClose = document.getElementById('clearAllModalClose');
                this.clearAllModalCancel = document.getElementById('clearAllModalCancel');
                this.clearAllModalConfirm = document.getElementById('clearAllModalConfirm');
                
                this.exportModal = document.getElementById('exportModal');
                this.exportModalClose = document.getElementById('exportModalClose');
            }

            attachEventListeners() {
                this.menuToggle.addEventListener('click', () => this.toggleSidebar());
                this.newChatBtn.addEventListener('click', () => this.startNewChat());
                this.sendButton.addEventListener('click', () => this.sendMessage());
                
                this.chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.chatInput.addEventListener('input', () => {
                    this.autoResizeTextarea();
                });

                this.gradeSelect.addEventListener('change', () => {
                    if (this.isWaitingForGrade && this.gradeSelect.value) {
                        this.sendMessageWithGrade();
                    }
                });

                this.themeToggle.addEventListener('click', () => this.toggleTheme());
                this.savePlanBtn.addEventListener('click', () => this.saveLessonPlan());
                this.exportPlanBtn.addEventListener('click', () => this.showExportModal());
                this.sharePlanBtn.addEventListener('click', () => this.shareLessonPlan());
                this.clearChatBtn.addEventListener('click', () => this.clearCurrentChat());
                
                // Input options
                this.inputOptions.querySelectorAll('.option-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.inputOptions.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentOption = btn.getAttribute('data-option');
                        this.updateInputPlaceholder();
                    });
                });
                
                // Modal event listeners
                this.deleteModalClose.addEventListener('click', () => this.hideDeleteModal());
                this.deleteModalCancel.addEventListener('click', () => this.hideDeleteModal());
                this.deleteModalConfirm.addEventListener('click', () => this.confirmDelete());
                
                this.clearAllModalClose.addEventListener('click', () => this.hideClearAllModal());
                this.clearAllModalCancel.addEventListener('click', () => this.hideClearAllModal());
                this.clearAllModalConfirm.addEventListener('click', () => this.confirmClearAll());
                
                this.exportModalClose.addEventListener('click', () => this.hideExportModal());
                
                // Export format buttons
                this.exportModal.querySelectorAll('.option-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const format = btn.getAttribute('data-format');
                        this.exportLessonPlan(format);
                    });
                });
            }

            toggleSidebar() {
                this.sidebar.classList.toggle('open');
            }

            autoResizeTextarea() {
                this.chatInput.style.height = 'auto';
                this.chatInput.style.height = Math.min(this.chatInput.scrollHeight, 200) + 'px';
            }

            updateInputPlaceholder() {
                const placeholders = {
                    'lesson': 'Describe your lesson plan needs...',
                    'activity': 'Describe the learning activity...',
                    'assessment': 'Describe the assessment method...'
                };
                this.chatInput.placeholder = placeholders[this.currentOption] || 'Message EduAI...';
            }

            async startNewChat() {
                this.currentConversationId = null;
                this.isWaitingForGrade = false;
                this.gradeSelector.style.display = 'none';
                this.gradeSelect.value = '';
                this.messagesContainer.innerHTML = '';
                this.showEmptyState();
                this.chatTitle.textContent = 'EduAI';
                this.chatInput.value = '';
                this.chatInput.focus();
                this.loadConversations();
            }

            showEmptyState() {
                this.emptyState.style.display = 'flex';
            }

            hideEmptyState() {
                this.emptyState.style.display = 'none';
            }

            async sendMessage() {
                const message = this.chatInput.value.trim();
                if (!message || this.isGenerating) return;

                this.chatInput.value = '';
                this.autoResizeTextarea();
                this.hideEmptyState();

                // Add user message to chat
                this.addMessageToChat('user', message);

                // Show typing indicator
                this.showTypingIndicator();

                this.isGenerating = true;
                this.sendButton.disabled = true;

                try {
                    const response = await fetch('/generate/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: message,
                            grade: this.gradeSelect.value,
                            conversation_id: this.currentConversationId,
                            option: this.currentOption
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    // Remove typing indicator
                    this.removeTypingIndicator();

                    // Handle the response
                    this.handleBotResponse(data);

                } catch (error) {
                    console.error('Error sending message:', error);
                    this.removeTypingIndicator();
                    this.addMessageToChat('bot', 'Sorry, I encountered an error. Please try again.');
                } finally {
                    this.isGenerating = false;
                    this.sendButton.disabled = false;
                }
            }

            async sendMessageWithGrade() {
                const grade = this.gradeSelect.value;
                if (!grade) return;

                const lastUserMessage = this.getLastUserMessage();
                if (!lastUserMessage) return;

                this.isWaitingForGrade = false;
                this.gradeSelector.style.display = 'none';

                // Show typing indicator
                this.showTypingIndicator();

                this.isGenerating = true;
                this.sendButton.disabled = true;

                try {
                    const response = await fetch('/generate/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: lastUserMessage,
                            grade: grade,
                            conversation_id: this.currentConversationId,
                            option: this.currentOption
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    this.removeTypingIndicator();
                    this.handleBotResponse(data);

                } catch (error) {
                    console.error('Error sending message with grade:', error);
                    this.removeTypingIndicator();
                    this.addMessageToChat('bot', 'Sorry, I encountered an error. Please try again.');
                } finally {
                    this.isGenerating = false;
                    this.sendButton.disabled = false;
                }
            }

            handleBotResponse(data) {
                this.currentConversationId = data.conversation_id;

                if (data.type === 'grade_request') {
                    this.isWaitingForGrade = true;
                    this.gradeSelector.style.display = 'flex';
                    this.gradeSelect.focus();
                } else {
                    this.addMessageToChat('bot', data.response, data.type);
                }

                // Update conversation list
                this.loadConversations();
            }

            getLastUserMessage() {
                const messages = this.messagesContainer.querySelectorAll('.message.user');
                if (messages.length === 0) return null;
                
                const lastMessage = messages[messages.length - 1];
                return lastMessage.querySelector('.message-text').textContent;
            }

            addMessageToChat(role, content, type = 'chat') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;

                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'avatar';
                avatarDiv.innerHTML = role === 'user' ? 
                    '<i class="fas fa-user"></i>' : 
                    '<i class="fas fa-robot"></i>';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';

                const textDiv = document.createElement('div');
                textDiv.className = 'message-text';
                textDiv.textContent = content;

                const metaDiv = document.createElement('div');
                metaDiv.className = 'message-meta';
                metaDiv.innerHTML = `
                    <span>${new Date().toLocaleTimeString()}</span>
                    <span>${type === 'lesson_plan' ? 'Lesson Plan' : 'Chat'}</span>
                `;

                contentDiv.appendChild(textDiv);
                contentDiv.appendChild(metaDiv);
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);

                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();

                // Update chat title if it's the first message
                if (this.messagesContainer.querySelectorAll('.message').length === 2) {
                    this.updateChatTitle(content);
                }
            }

            updateChatTitle(firstMessage) {
                // Create a short title from the first message
                const title = firstMessage.length > 30 ? 
                    firstMessage.substring(0, 30) + '...' : firstMessage;
                this.chatTitle.textContent = title;
            }

            showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message bot';
                typingDiv.id = 'typingIndicator';

                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'avatar';
                avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';

                const typingContent = document.createElement('div');
                typingContent.className = 'typing-indicator';
                typingContent.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                `;

                typingDiv.appendChild(avatarDiv);
                typingDiv.appendChild(typingContent);
                this.messagesContainer.appendChild(typingDiv);
                this.scrollToBottom();
            }

            removeTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            async loadConversations() {
                try {
                    const response = await fetch('/conversations/');
                    if (response.ok) {
                        this.conversations = await response.json();
                        this.renderConversationHistory();
                    }
                } catch (error) {
                    console.error('Error loading conversations:', error);
                }
            }

            renderConversationHistory() {
                this.conversationHistory.innerHTML = '';
                
                // Add "Clear All" button
                if (this.conversations.length > 0) {
                    const clearAllDiv = document.createElement('div');
                    clearAllDiv.className = 'conversation-item';
                    clearAllDiv.style.justifyContent = 'center';
                    clearAllDiv.style.marginTop = '10px';
                    clearAllDiv.style.padding = '10px';
                    clearAllDiv.style.cursor = 'pointer';
                    clearAllDiv.style.color = '#ef4444';
                    clearAllDiv.innerHTML = `
                        <i class="fas fa-trash-alt"></i>
                        <span style="margin-left: 8px;">Clear All Chats</span>
                    `;
                    clearAllDiv.addEventListener('click', () => this.showClearAllModal());
                    this.conversationHistory.appendChild(clearAllDiv);
                }
                
                this.conversations.forEach(conv => {
                    const convItem = document.createElement('div');
                    convItem.className = 'conversation-item';
                    if (conv.id === this.currentConversationId) {
                        convItem.classList.add('active');
                    }
                    
                    convItem.innerHTML = `
                        <div style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; flex: 1;">
                            ${this.getConversationTitle(conv)}
                        </div>
                        <div class="conversation-actions">
                            <button class="conversation-action-btn" data-id="${conv.id}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; width: 100%;">
                            ${new Date(conv.created_at).toLocaleDateString()} â€¢ 
                            ${conv.message_count} messages
                        </div>
                    `;
                    
                    convItem.addEventListener('click', (e) => {
                        if (!e.target.closest('.conversation-actions')) {
                            this.loadConversation(conv.id);
                        }
                    });
                    
                    const deleteBtn = convItem.querySelector('.conversation-action-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.showDeleteModal(conv.id);
                    });
                    
                    this.conversationHistory.appendChild(convItem);
                });
            }

            getConversationTitle(conversation) {
                return conversation.title || `Lesson ${conversation.id.substring(0, 8)}...`;
            }

            async loadConversation(conversationId) {
                try {
                    const response = await fetch(`/conversation/${conversationId}`);
                    if (response.ok) {
                        const conversation = await response.json();
                        this.displayConversation(conversation);
                    }
                } catch (error) {
                    console.error('Error loading conversation:', error);
                }
            }

            displayConversation(conversation) {
                this.currentConversationId = conversation.id;
                this.messagesContainer.innerHTML = '';
                this.hideEmptyState();

                conversation.messages.forEach(msg => {
                    this.addMessageToChat(msg.role, msg.content, msg.type || 'chat');
                });

                this.updateChatTitle(conversation.messages[0]?.content || 'Lesson Plan');
                this.loadConversations();
            }

            toggleTheme() {
                this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                this.applyTheme();
                localStorage.setItem('eduai-theme', this.currentTheme);
            }

            applyTheme() {
                document.body.setAttribute('data-theme', this.currentTheme);
                
                const themeIcon = this.themeToggle.querySelector('i');
                const themeText = this.themeToggle.querySelector('span');
                
                if (this.currentTheme === 'dark') {
                    themeIcon.className = 'fas fa-sun';
                    themeText.textContent = 'Light Mode';
                } else {
                    themeIcon.className = 'fas fa-moon';
                    themeText.textContent = 'Dark Mode';
                }
            }

            saveLessonPlan() {
                // Get all bot messages that contain lesson plans
                const botMessages = this.messagesContainer.querySelectorAll('.message.bot');
                if (botMessages.length === 0) {
                    alert('No lesson plan found to save.');
                    return;
                }
                
                // Get the latest bot message
                const latestBotMessage = botMessages[botMessages.length - 1];
                const messageContent = latestBotMessage.querySelector('.message-text');
                
                if (!messageContent) {
                    alert('No lesson plan content found to save.');
                    return;
                }
                
                const lessonContent = messageContent.textContent || messageContent.innerText;
                
                // In a real app, this would save to a database
                // For now, we'll save to localStorage as a fallback
                try {
                    const savedPlans = JSON.parse(localStorage.getItem('eduai-saved-plans') || '[]');
                    savedPlans.push({
                        id: Date.now().toString(),
                        title: this.chatTitle.textContent,
                        content: lessonContent,
                        savedAt: new Date().toISOString(),
                        conversationId: this.currentConversationId
                    });
                    localStorage.setItem('eduai-saved-plans', JSON.stringify(savedPlans));
                    
                    alert('Lesson plan saved successfully!');
                    this.showStatus('Lesson plan saved successfully!', 'success');
                } catch (error) {
                    console.error('Error saving lesson plan:', error);
                    alert('Error saving lesson plan. Please try again.');
                }
            }

            showExportModal() {
                this.exportModal.style.display = 'flex';
            }

            hideExportModal() {
                this.exportModal.style.display = 'none';
            }

            exportLessonPlan(format) {
                // Get all bot messages that contain lesson plans
                const botMessages = this.messagesContainer.querySelectorAll('.message.bot');
                if (botMessages.length === 0) {
                    alert('No lesson plan found to export.');
                    return;
                }
                
                // Get the latest bot message
                const latestBotMessage = botMessages[botMessages.length - 1];
                const messageContent = latestBotMessage.querySelector('.message-text');
                
                if (!messageContent) {
                    alert('No lesson plan content found to export.');
                    return;
                }
                
                let lessonContent = messageContent.textContent || messageContent.innerText;
                let mimeType, fileExtension;
                
                // Set proper MIME type and file extension based on format
                switch(format) {
                    case 'pdf':
                        // For PDF, we'll create a formatted text file (actual PDF would require a library)
                        mimeType = 'application/pdf';
                        fileExtension = 'pdf';
                        // Create a more structured content for PDF-like format
                        lessonContent = this.formatLessonPlanContent(lessonContent, 'pdf');
                        break;
                    case 'docx':
                        mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                        fileExtension = 'docx';
                        lessonContent = this.formatLessonPlanContent(lessonContent, 'docx');
                        break;
                    case 'txt':
                    default:
                        mimeType = 'text/plain';
                        fileExtension = 'txt';
                        lessonContent = this.formatLessonPlanContent(lessonContent, 'txt');
                        break;
                }
                
                // Create and download the file
                const blob = new Blob([lessonContent], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // Create a proper filename with date and title
                const title = this.chatTitle.textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                a.download = `lesson_plan_${title}_${new Date().toISOString().slice(0, 10)}.${fileExtension}`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.hideExportModal();
                this.showStatus(`Lesson plan exported as ${format.toUpperCase()}!`, 'success');
            }

            formatLessonPlanContent(content, format) {
                let formattedContent = content;
                
                switch(format) {
                    case 'pdf':
                        // Format for PDF-like structure
                        formattedContent = `EDUAI LESSON PLAN\n` +
                                         `===================\n\n` +
                                         `Title: ${this.chatTitle.textContent}\n` +
                                         `Date: ${new Date().toLocaleDateString()}\n` +
                                         `Generated by: EduAI Assistant\n\n` +
                                         `CONTENT:\n` +
                                         `--------\n${content}\n\n` +
                                         `Â© ${new Date().getFullYear()} EduAI - All rights reserved`;
                        break;
                        
                    case 'docx':
                        // Format for Word document structure
                        formattedContent = `EDUAI LESSON PLAN\n` +
                                         `Title: ${this.chatTitle.textContent}\n` +
                                         `Date: ${new Date().toLocaleDateString()}\n` +
                                         `Generated by: EduAI Assistant\n\n` +
                                         `${content}\n\n` +
                                         `End of Lesson Plan`;
                        break;
                        
                    case 'txt':
                    default:
                        // Format for plain text
                        formattedContent = `EDUAI LESSON PLAN\n` +
                                         `Title: ${this.chatTitle.textContent}\n` +
                                         `Date: ${new Date().toLocaleDateString()}\n` +
                                         `Generated by: EduAI Assistant\n\n` +
                                         `${content}`;
                        break;
                }
                
                return formattedContent;
            }

            shareLessonPlan() {
                // Get all bot messages that contain lesson plans
                const botMessages = this.messagesContainer.querySelectorAll('.message.bot');
                if (botMessages.length === 0) {
                    alert('No lesson plan found to share.');
                    return;
                }
                
                // Get the latest bot message
                const latestBotMessage = botMessages[botMessages.length - 1];
                const messageContent = latestBotMessage.querySelector('.message-text');
                
                if (!messageContent) {
                    alert('No lesson plan content found to share.');
                    return;
                }
                
                const lessonContent = messageContent.textContent || messageContent.innerText;
                
                // Create a shareable text (in a real app, this would generate a link)
                const shareableContent = `Check out this lesson plan from EduAI:\n\n` +
                                       `"${this.chatTitle.textContent}"\n\n` +
                                       `${lessonContent.substring(0, 200)}...\n\n` +
                                       `Generated by EduAI Lesson Planning Assistant`;
                
                // For demo purposes, show the content and simulate sharing
                if (navigator.share) {
                    // Use Web Share API if available
                    navigator.share({
                        title: `Lesson Plan: ${this.chatTitle.textContent}`,
                        text: shareableContent
                    }).then(() => {
                        this.showStatus('Lesson plan shared successfully!', 'success');
                    }).catch(error => {
                        console.error('Error sharing:', error);
                        this.fallbackShare(shareableContent);
                    });
                } else {
                    this.fallbackShare(shareableContent);
                }
            }

            fallbackShare(content) {
                // Copy to clipboard as fallback
                navigator.clipboard.writeText(content).then(() => {
                    alert('Lesson plan content copied to clipboard! You can now paste it anywhere.');
                    this.showStatus('Lesson plan copied to clipboard!', 'success');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Share feature would generate a link to this lesson plan.');
                    this.showStatus('Share link generated!', 'success');
                });
            }

            clearCurrentChat() {
                if (this.messagesContainer.querySelectorAll('.message').length === 0) {
                    return;
                }
                
                if (confirm('Are you sure you want to clear this chat? This will remove all messages from the current view.')) {
                    this.messagesContainer.innerHTML = '';
                    this.showEmptyState();
                    this.chatTitle.textContent = 'EduAI';
                    this.currentConversationId = null;
                }
            }

            showDeleteModal(conversationId) {
                this.conversationToDelete = conversationId;
                this.deleteModal.style.display = 'flex';
            }

            hideDeleteModal() {
                this.deleteModal.style.display = 'none';
                this.conversationToDelete = null;
            }

            async confirmDelete() {
                if (!this.conversationToDelete) return;
                
                try {
                    const response = await fetch(`/conversation/${this.conversationToDelete}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        // If we're currently viewing the deleted conversation, clear the chat
                        if (this.currentConversationId === this.conversationToDelete) {
                            this.startNewChat();
                        }
                        
                        this.loadConversations();
                        this.hideDeleteModal();
                        this.showStatus('Lesson plan deleted successfully!', 'success');
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error deleting conversation:', error);
                    alert('Failed to delete lesson plan. Please try again.');
                    this.showStatus('Failed to delete lesson plan!', 'danger');
                }
            }

            showClearAllModal() {
                this.clearAllModal.style.display = 'flex';
            }

            hideClearAllModal() {
                this.clearAllModal.style.display = 'none';
            }

            async confirmClearAll() {
                try {
                    const response = await fetch('/conversations/', {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        this.startNewChat();
                        this.loadConversations();
                        this.hideClearAllModal();
                        this.showStatus('All lesson plans cleared!', 'success');
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error clearing all conversations:', error);
                    alert('Failed to clear all lesson plans. Please try again.');
                    this.showStatus('Failed to clear all lesson plans!', 'danger');
                }
            }

            showStatus(message, type) {
                // Create status indicator
                const statusDiv = document.createElement('div');
                statusDiv.className = `status-indicator ${type}`;
                statusDiv.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                `;
                
                // Add to chat header
                this.chatHeader.appendChild(statusDiv);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.parentNode.removeChild(statusDiv);
                    }
                }, 3000);
            }
        }

        // Initialize the chat when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new EduAIChat();
        });
    </script>
</body>
</html>